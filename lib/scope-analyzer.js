"use strict";

var _extends = function (child, parent) {
  child.prototype = Object.create(parent.prototype, {
    constructor: {
      value: child,
      enumerable: false,
      writable: true,
      configurable: true
    }
  });
  child.__proto__ = parent;
};

var reduce = require("shift-reducer")["default"];
var MonoidalReducer = require("shift-reducer").MonoidalReducer;
var ScopeState = require("./scope-state")["default"];
var ReadReference = require("./reference").ReadReference;
var WriteReference = require("./reference").WriteReference;
var ReadWriteReference = require("./reference").ReadWriteReference;
var Declaration = require("./declaration").Declaration;
var VarDeclaration = require("./declaration").VarDeclaration;
var ConstDeclaration = require("./declaration").ConstDeclaration;
var LetDeclaration = require("./declaration").LetDeclaration;
var CatchDeclaration = require("./declaration").CatchDeclaration;
var ParameterDeclaration = require("./declaration").ParameterDeclaration;
var FunctionNameDeclaration = require("./declaration").FunctionNameDeclaration;
var ScopeType = require("./scope").ScopeType;
var ScopeAnalyzer = (function (MonoidalReducer) {
  var ScopeAnalyzer = function ScopeAnalyzer() {
    MonoidalReducer.call(this, ScopeState);
  };

  _extends(ScopeAnalyzer, MonoidalReducer);

  ScopeAnalyzer.analyze = function (script) {
    return reduce(new this(), script).children[0];
  };

  ScopeAnalyzer.prototype.reduceAssignmentExpression = function (node, binding, expression) {
    if (node.binding.type === "IdentifierExpression") {
      var ReferenceCtor = node.operator === "=" ? WriteReference : ReadWriteReference;
      return expression.addReference(new ReferenceCtor(node.binding.identifier));
    }
    return MonoidalReducer.prototype.reduceAssignmentExpression.call(this, node, binding, expression);
  };

  ScopeAnalyzer.prototype.reduceBlock = function (node, statements) {
    var s = MonoidalReducer.prototype.reduceBlock.call(this, node, statements);
    if (s.blockScopedDeclarations.size > 0) {
      s = s.finish(node, ScopeType.BLOCK);
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceCallExpression = function (node, callee, args) {
    var s = MonoidalReducer.prototype.reduceCallExpression.call(this, node, callee, args);
    if (node.callee.type === "IdentifierExpression" && node.callee.identifier.name === "eval") {
      return s.taint();
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceCatchClause = function (node, binding, body) {
    return MonoidalReducer.prototype.reduceCatchClause.call(this, node, binding, body).addDeclaration(new CatchDeclaration(node.binding)).finish(node, ScopeType.CATCH);
  };

  ScopeAnalyzer.prototype.reduceForInStatement = function (node, left, right, body) {
    var s = MonoidalReducer.prototype.reduceForInStatement.call(this, node, left, right, body);
    if (node.left.type === "IdentifierExpression") {
      return this.append(right, body).addReference(new WriteReference(node.left.identifier));
    } else if (node.left.type === "VariableDeclaration" && node.left.declarators[0].init == null) {
      s = s.addReference(new WriteReference(node.left.declarators[0].binding));
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceFunctionDeclaration = function (node, name, parameters, functionBody) {
    return node.parameters.reduce(function (s, p) {
      return s.addDeclaration(new ParameterDeclaration(p));
    }, functionBody).finish(node, ScopeType.FUNCTION).addDeclaration(new FunctionNameDeclaration(node.name));
  };

  ScopeAnalyzer.prototype.reduceFunctionExpression = function (node, name, parameters, functionBody) {
    var s = node.parameters.reduce(function (s, p) {
      return s.addDeclaration(new ParameterDeclaration(p));
    }, functionBody).finish(node, ScopeType.FUNCTION);
    if (name != null) {
      s = s.addDeclaration(new FunctionNameDeclaration(node.name)).finish(node, ScopeType.FUNCTION_NAME);
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceGetter = function (node, name, body) {
    return body.finish(node, ScopeType.FUNCTION);
  };

  ScopeAnalyzer.prototype.reduceIdentifierExpression = function (node, identifier) {
    return this.identity.addReference(new ReadReference(node.identifier));
  };

  ScopeAnalyzer.prototype.reducePostfixExpression = function (node, operand) {
    if (node.operand.type === "IdentifierExpression") {
      return this.identity.addReference(new ReadWriteReference(node.operand.identifier));
    }
    return operand;
  };

  ScopeAnalyzer.prototype.reducePrefixExpression = function (node, operand) {
    if ((node.operator === "--" || node.operator === "++") && node.operand.type === "IdentifierExpression") {
      return this.identity.addReference(new ReadWriteReference(node.operand.identifier));
    }
    return operand;
  };

  ScopeAnalyzer.prototype.reduceScript = function (node, body) {
    return body.finish(node, ScopeType.GLOBAL);
  };

  ScopeAnalyzer.prototype.reduceSetter = function (node, name, parameter, body) {
    return body.addDeclaration(new ParameterDeclaration(node.parameter)).finish(node, ScopeType.FUNCTION);
  };

  ScopeAnalyzer.prototype.reduceVariableDeclaration = function (node, declarators) {
    return node.declarators.reduce(function (s, d) {
      return s.addDeclaration(Declaration.fromVarDeclKind(d.binding, node.kind));
    }, MonoidalReducer.prototype.reduceVariableDeclaration.call(this, node, declarators));
  };

  ScopeAnalyzer.prototype.reduceVariableDeclarator = function (node, binding, init) {
    var s = MonoidalReducer.prototype.reduceVariableDeclarator.call(this, node, binding, init);
    if (init != null) {
      s = s.addReference(new WriteReference(node.binding));
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceWithStatement = function (node, object, body) {
    return MonoidalReducer.prototype.reduceWithStatement.call(this, node, object, body.finish(node, ScopeType.WITH));
  };

  return ScopeAnalyzer;
})(MonoidalReducer);

exports["default"] = ScopeAnalyzer;
//# sourceMappingURL=data:application/json;base64,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MjAxNCBTaGFwZSBTZWN1cml0eSwgSW5jLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIilcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCByZWR1Y2UsIHtNb25vaWRhbFJlZHVjZXJ9IGZyb20gXCJzaGlmdC1yZWR1Y2VyXCI7XG5pbXBvcnQgU2NvcGVTdGF0ZSBmcm9tIFwiLi9zY29wZS1zdGF0ZVwiO1xuaW1wb3J0IHtSZWFkUmVmZXJlbmNlLCBXcml0ZVJlZmVyZW5jZSwgUmVhZFdyaXRlUmVmZXJlbmNlfSBmcm9tIFwiLi9yZWZlcmVuY2VcIjtcbmltcG9ydCB7RGVjbGFyYXRpb24sIFZhckRlY2xhcmF0aW9uLCBDb25zdERlY2xhcmF0aW9uLCBMZXREZWNsYXJhdGlvbiwgQ2F0Y2hEZWNsYXJhdGlvbiwgUGFyYW1ldGVyRGVjbGFyYXRpb24sIEZ1bmN0aW9uTmFtZURlY2xhcmF0aW9ufSBmcm9tIFwiLi9kZWNsYXJhdGlvblwiO1xuaW1wb3J0IHtTY29wZVR5cGV9IGZyb20gXCIuL3Njb3BlXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNjb3BlQW5hbHl6ZXIgZXh0ZW5kcyBNb25vaWRhbFJlZHVjZXIge1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKFNjb3BlU3RhdGUpO1xuICB9XG5cbiAgc3RhdGljIGFuYWx5emUoc2NyaXB0KSB7XG4gICAgcmV0dXJuIHJlZHVjZShuZXcgdGhpcywgc2NyaXB0KS5jaGlsZHJlblswXTtcbiAgfVxuXG4gIHJlZHVjZUFzc2lnbm1lbnRFeHByZXNzaW9uKG5vZGUsIGJpbmRpbmcsIGV4cHJlc3Npb24pIHtcbiAgICBpZiAobm9kZS5iaW5kaW5nLnR5cGUgPT09IFwiSWRlbnRpZmllckV4cHJlc3Npb25cIikge1xuICAgICAgbGV0IFJlZmVyZW5jZUN0b3IgPSBub2RlLm9wZXJhdG9yID09PSBcIj1cIiA/IFdyaXRlUmVmZXJlbmNlIDogUmVhZFdyaXRlUmVmZXJlbmNlO1xuICAgICAgcmV0dXJuIGV4cHJlc3Npb24uYWRkUmVmZXJlbmNlKG5ldyBSZWZlcmVuY2VDdG9yKG5vZGUuYmluZGluZy5pZGVudGlmaWVyKSk7XG4gICAgfVxuICAgIHJldHVybiBzdXBlci5yZWR1Y2VBc3NpZ25tZW50RXhwcmVzc2lvbihub2RlLCBiaW5kaW5nLCBleHByZXNzaW9uKTtcbiAgfVxuXG4gIHJlZHVjZUJsb2NrKG5vZGUsIHN0YXRlbWVudHMpIHtcbiAgICBsZXQgcyA9IHN1cGVyLnJlZHVjZUJsb2NrKG5vZGUsIHN0YXRlbWVudHMpO1xuICAgIGlmIChzLmJsb2NrU2NvcGVkRGVjbGFyYXRpb25zLnNpemUgPiAwKSB7XG4gICAgICBzID0gcy5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkJMT0NLKTtcbiAgICB9XG4gICAgcmV0dXJuIHM7XG4gIH1cblxuICByZWR1Y2VDYWxsRXhwcmVzc2lvbihub2RlLCBjYWxsZWUsIGFyZ3MpIHtcbiAgICBsZXQgcyA9IHN1cGVyLnJlZHVjZUNhbGxFeHByZXNzaW9uKG5vZGUsIGNhbGxlZSwgYXJncyk7XG4gICAgaWYgKG5vZGUuY2FsbGVlLnR5cGUgPT09IFwiSWRlbnRpZmllckV4cHJlc3Npb25cIiAmJiBub2RlLmNhbGxlZS5pZGVudGlmaWVyLm5hbWUgPT09IFwiZXZhbFwiKSB7XG4gICAgICByZXR1cm4gcy50YWludCgpO1xuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfVxuXG4gIHJlZHVjZUNhdGNoQ2xhdXNlKG5vZGUsIGJpbmRpbmcsIGJvZHkpIHtcbiAgICByZXR1cm4gc3VwZXIucmVkdWNlQ2F0Y2hDbGF1c2Uobm9kZSwgYmluZGluZywgYm9keSlcbiAgICAgIC5hZGREZWNsYXJhdGlvbihuZXcgQ2F0Y2hEZWNsYXJhdGlvbihub2RlLmJpbmRpbmcpKVxuICAgICAgLmZpbmlzaChub2RlLCBTY29wZVR5cGUuQ0FUQ0gpO1xuICB9XG5cbiAgcmVkdWNlRm9ySW5TdGF0ZW1lbnQobm9kZSwgbGVmdCwgcmlnaHQsIGJvZHkpIHtcbiAgICBsZXQgcyA9IHN1cGVyLnJlZHVjZUZvckluU3RhdGVtZW50KG5vZGUsIGxlZnQsIHJpZ2h0LCBib2R5KTtcbiAgICBpZiAobm9kZS5sZWZ0LnR5cGUgPT09IFwiSWRlbnRpZmllckV4cHJlc3Npb25cIikge1xuICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kKHJpZ2h0LCBib2R5KS5hZGRSZWZlcmVuY2UobmV3IFdyaXRlUmVmZXJlbmNlKG5vZGUubGVmdC5pZGVudGlmaWVyKSk7XG4gICAgfSBlbHNlIGlmIChub2RlLmxlZnQudHlwZSA9PT0gXCJWYXJpYWJsZURlY2xhcmF0aW9uXCIgJiYgbm9kZS5sZWZ0LmRlY2xhcmF0b3JzWzBdLmluaXQgPT0gbnVsbCkge1xuICAgICAgcyA9IHMuYWRkUmVmZXJlbmNlKG5ldyBXcml0ZVJlZmVyZW5jZShub2RlLmxlZnQuZGVjbGFyYXRvcnNbMF0uYmluZGluZykpO1xuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfVxuXG4gIHJlZHVjZUZ1bmN0aW9uRGVjbGFyYXRpb24obm9kZSwgbmFtZSwgcGFyYW1ldGVycywgZnVuY3Rpb25Cb2R5KSB7XG4gICAgcmV0dXJuIG5vZGUucGFyYW1ldGVycy5yZWR1Y2UoKHMsIHApID0+IHMuYWRkRGVjbGFyYXRpb24obmV3IFBhcmFtZXRlckRlY2xhcmF0aW9uKHApKSwgZnVuY3Rpb25Cb2R5KVxuICAgICAgLmZpbmlzaChub2RlLCBTY29wZVR5cGUuRlVOQ1RJT04pXG4gICAgICAuYWRkRGVjbGFyYXRpb24obmV3IEZ1bmN0aW9uTmFtZURlY2xhcmF0aW9uKG5vZGUubmFtZSkpO1xuICB9XG5cbiAgcmVkdWNlRnVuY3Rpb25FeHByZXNzaW9uKG5vZGUsIG5hbWUsIHBhcmFtZXRlcnMsIGZ1bmN0aW9uQm9keSkge1xuICAgIGxldCBzID0gbm9kZS5wYXJhbWV0ZXJzLnJlZHVjZSgocywgcCkgPT4gcy5hZGREZWNsYXJhdGlvbihuZXcgUGFyYW1ldGVyRGVjbGFyYXRpb24ocCkpLCBmdW5jdGlvbkJvZHkpXG4gICAgICAuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5GVU5DVElPTik7XG4gICAgaWYgKG5hbWUgIT0gbnVsbCkge1xuICAgICAgcyA9IHMuYWRkRGVjbGFyYXRpb24obmV3IEZ1bmN0aW9uTmFtZURlY2xhcmF0aW9uKG5vZGUubmFtZSkpXG4gICAgICAgIC5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkZVTkNUSU9OX05BTUUpO1xuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfVxuXG4gIHJlZHVjZUdldHRlcihub2RlLCBuYW1lLCBib2R5KSB7XG4gICAgcmV0dXJuIGJvZHkuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5GVU5DVElPTik7XG4gIH1cblxuICByZWR1Y2VJZGVudGlmaWVyRXhwcmVzc2lvbihub2RlLCBpZGVudGlmaWVyKSB7XG4gICAgcmV0dXJuIHRoaXMuaWRlbnRpdHkuYWRkUmVmZXJlbmNlKG5ldyBSZWFkUmVmZXJlbmNlKG5vZGUuaWRlbnRpZmllcikpO1xuICB9XG5cbiAgcmVkdWNlUG9zdGZpeEV4cHJlc3Npb24obm9kZSwgb3BlcmFuZCkge1xuICAgIGlmIChub2RlLm9wZXJhbmQudHlwZSA9PT0gXCJJZGVudGlmaWVyRXhwcmVzc2lvblwiKSB7XG4gICAgICByZXR1cm4gdGhpcy5pZGVudGl0eS5hZGRSZWZlcmVuY2UobmV3IFJlYWRXcml0ZVJlZmVyZW5jZShub2RlLm9wZXJhbmQuaWRlbnRpZmllcikpO1xuICAgIH1cbiAgICByZXR1cm4gb3BlcmFuZDtcbiAgfVxuXG4gIHJlZHVjZVByZWZpeEV4cHJlc3Npb24obm9kZSwgb3BlcmFuZCkge1xuICAgIGlmICgobm9kZS5vcGVyYXRvciA9PT0gXCItLVwiIHx8IG5vZGUub3BlcmF0b3IgPT09IFwiKytcIikgJiYgbm9kZS5vcGVyYW5kLnR5cGUgPT09IFwiSWRlbnRpZmllckV4cHJlc3Npb25cIikge1xuICAgICAgcmV0dXJuIHRoaXMuaWRlbnRpdHkuYWRkUmVmZXJlbmNlKG5ldyBSZWFkV3JpdGVSZWZlcmVuY2Uobm9kZS5vcGVyYW5kLmlkZW50aWZpZXIpKTtcbiAgICB9XG4gICAgcmV0dXJuIG9wZXJhbmQ7XG4gIH1cblxuICByZWR1Y2VTY3JpcHQobm9kZSwgYm9keSkge1xuICAgIHJldHVybiBib2R5LmZpbmlzaChub2RlLCBTY29wZVR5cGUuR0xPQkFMKTtcbiAgfVxuXG4gIHJlZHVjZVNldHRlcihub2RlLCBuYW1lLCBwYXJhbWV0ZXIsIGJvZHkpIHtcbiAgICByZXR1cm4gYm9keS5hZGREZWNsYXJhdGlvbihuZXcgUGFyYW1ldGVyRGVjbGFyYXRpb24obm9kZS5wYXJhbWV0ZXIpKVxuICAgICAgLmZpbmlzaChub2RlLCBTY29wZVR5cGUuRlVOQ1RJT04pO1xuICB9XG5cbiAgcmVkdWNlVmFyaWFibGVEZWNsYXJhdGlvbihub2RlLCBkZWNsYXJhdG9ycykge1xuICAgIHJldHVybiBub2RlLmRlY2xhcmF0b3JzLnJlZHVjZShcbiAgICAgIChzLCBkKSA9PiBzLmFkZERlY2xhcmF0aW9uKERlY2xhcmF0aW9uLmZyb21WYXJEZWNsS2luZChkLmJpbmRpbmcsIG5vZGUua2luZCkpLFxuICAgICAgc3VwZXIucmVkdWNlVmFyaWFibGVEZWNsYXJhdGlvbihub2RlLCBkZWNsYXJhdG9ycylcbiAgICApO1xuICB9XG5cbiAgcmVkdWNlVmFyaWFibGVEZWNsYXJhdG9yKG5vZGUsIGJpbmRpbmcsIGluaXQpIHtcbiAgICBsZXQgcyA9IHN1cGVyLnJlZHVjZVZhcmlhYmxlRGVjbGFyYXRvcihub2RlLCBiaW5kaW5nLCBpbml0KTtcbiAgICBpZiAoaW5pdCAhPSBudWxsKSB7XG4gICAgICBzID0gcy5hZGRSZWZlcmVuY2UobmV3IFdyaXRlUmVmZXJlbmNlKG5vZGUuYmluZGluZykpO1xuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfVxuXG4gIHJlZHVjZVdpdGhTdGF0ZW1lbnQobm9kZSwgb2JqZWN0LCBib2R5KSB7XG4gICAgcmV0dXJuIHN1cGVyLnJlZHVjZVdpdGhTdGF0ZW1lbnQobm9kZSwgb2JqZWN0LCBib2R5LmZpbmlzaChub2RlLCBTY29wZVR5cGUuV0lUSCkpO1xuICB9XG59XG4iXX0=