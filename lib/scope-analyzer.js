"use strict";

var _extends = function (child, parent) {
  child.prototype = Object.create(parent.prototype, {
    constructor: {
      value: child,
      enumerable: false,
      writable: true,
      configurable: true
    }
  });
  child.__proto__ = parent;
};

var reduce = require("shift-reducer")["default"];
var MonoidalReducer = require("shift-reducer").MonoidalReducer;
var ScopeState = require("./scope-state")["default"];
var ReadReference = require("./reference").ReadReference;
var WriteReference = require("./reference").WriteReference;
var ReadWriteReference = require("./reference").ReadWriteReference;
var Declaration = require("./declaration").Declaration;
var VarDeclaration = require("./declaration").VarDeclaration;
var ConstDeclaration = require("./declaration").ConstDeclaration;
var LetDeclaration = require("./declaration").LetDeclaration;
var CatchDeclaration = require("./declaration").CatchDeclaration;
var ParameterDeclaration = require("./declaration").ParameterDeclaration;
var FunctionNameDeclaration = require("./declaration").FunctionNameDeclaration;
var ScopeType = require("./scope").ScopeType;
var ScopeAnalyzer = (function (MonoidalReducer) {
  var ScopeAnalyzer = function ScopeAnalyzer() {
    MonoidalReducer.call(this, ScopeState);
  };

  _extends(ScopeAnalyzer, MonoidalReducer);

  ScopeAnalyzer.analyze = function (script) {
    return reduce(new this(), script).children[0];
  };

  ScopeAnalyzer.prototype.reduceAssignmentExpression = function (node, binding, expression) {
    if (node.binding.type === "IdentifierExpression") {
      var ReferenceCtor = node.operator === "=" ? WriteReference : ReadWriteReference;
      return expression.addReference(new ReferenceCtor(node.binding.identifier));
    }
    return MonoidalReducer.prototype.reduceAssignmentExpression.call(this, node, binding, expression);
  };

  ScopeAnalyzer.prototype.reduceBlock = function (node, statements) {
    var s = MonoidalReducer.prototype.reduceBlock.call(this, node, statements);
    if (s.blockScopedDeclarations.size > 0) {
      s = s.finish(node, ScopeType.BLOCK);
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceCallExpression = function (node, callee, args) {
    var s = MonoidalReducer.prototype.reduceCallExpression.call(this, node, callee, args);
    if (node.callee.type === "IdentifierExpression" && node.callee.identifier.name === "eval") {
      return s.taint();
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceCatchClause = function (node, binding, body) {
    return MonoidalReducer.prototype.reduceCatchClause.call(this, node, binding, body).addDeclaration(new CatchDeclaration(node.binding)).finish(node, ScopeType.CATCH);
  };

  ScopeAnalyzer.prototype.reduceForInStatement = function (node, left, right, body) {
    if (node.left.type === "IdentifierExpression") {
      return this.append(right, body).addReference(new WriteReference(node.left.identifier));
    } else {
      // node.left.type === "VariableDeclaration"
      var declarator = node.left.declarators[0];
      if (declarator.init == null) {
        left = left.addReference(new WriteReference(declarator.binding));
      }
      if (left.blockScopedDeclarations.size > 0) {
        return this.append(this.append(left, body).finish(node, ScopeType.BLOCK), right);
      }
      return MonoidalReducer.prototype.reduceForInStatement.call(this, node, left, right, body);
    }
  };

  ScopeAnalyzer.prototype.reduceForStatement = function (node, init, test, update, body) {
    if (node.init.type === "VariableDeclaration" && init.blockScopedDeclarations.size > 0) {
      return this.append3(this.append(init, body).finish(node, ScopeType.BLOCK), test, update);
    }
    return MonoidalReducer.prototype.reduceForStatement.call(this, node, init, test, update, body);
  };

  ScopeAnalyzer.prototype.reduceFunctionDeclaration = function (node, name, parameters, functionBody) {
    return node.parameters.reduce(function (s, p) {
      return s.addDeclaration(new ParameterDeclaration(p));
    }, functionBody).finish(node, ScopeType.FUNCTION).addDeclaration(new FunctionNameDeclaration(node.name));
  };

  ScopeAnalyzer.prototype.reduceFunctionExpression = function (node, name, parameters, functionBody) {
    var s = node.parameters.reduce(function (s, p) {
      return s.addDeclaration(new ParameterDeclaration(p));
    }, functionBody).finish(node, ScopeType.FUNCTION);
    if (name != null) {
      s = s.addDeclaration(new FunctionNameDeclaration(node.name)).finish(node, ScopeType.FUNCTION_NAME);
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceGetter = function (node, name, body) {
    return body.finish(node, ScopeType.FUNCTION);
  };

  ScopeAnalyzer.prototype.reduceIdentifierExpression = function (node, identifier) {
    return this.identity.addReference(new ReadReference(node.identifier));
  };

  ScopeAnalyzer.prototype.reducePostfixExpression = function (node, operand) {
    if (node.operand.type === "IdentifierExpression") {
      return this.identity.addReference(new ReadWriteReference(node.operand.identifier));
    }
    return operand;
  };

  ScopeAnalyzer.prototype.reducePrefixExpression = function (node, operand) {
    if ((node.operator === "--" || node.operator === "++") && node.operand.type === "IdentifierExpression") {
      return this.identity.addReference(new ReadWriteReference(node.operand.identifier));
    }
    return operand;
  };

  ScopeAnalyzer.prototype.reduceScript = function (node, body) {
    return body.finish(node, ScopeType.GLOBAL);
  };

  ScopeAnalyzer.prototype.reduceSetter = function (node, name, parameter, body) {
    return body.addDeclaration(new ParameterDeclaration(node.parameter)).finish(node, ScopeType.FUNCTION);
  };

  ScopeAnalyzer.prototype.reduceVariableDeclaration = function (node, declarators) {
    return node.declarators.reduce(function (s, d) {
      return s.addDeclaration(Declaration.fromVarDeclKind(d.binding, node.kind));
    }, MonoidalReducer.prototype.reduceVariableDeclaration.call(this, node, declarators));
  };

  ScopeAnalyzer.prototype.reduceVariableDeclarator = function (node, binding, init) {
    var s = MonoidalReducer.prototype.reduceVariableDeclarator.call(this, node, binding, init);
    if (init != null) {
      s = s.addReference(new WriteReference(node.binding));
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceWithStatement = function (node, object, body) {
    return MonoidalReducer.prototype.reduceWithStatement.call(this, node, object, body.finish(node, ScopeType.WITH));
  };

  return ScopeAnalyzer;
})(MonoidalReducer);

exports["default"] = ScopeAnalyzer;
//# sourceMappingURL=data:application/json;base64,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LEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtBQUM1QyxRQUFJLENBQUMsR0FySGtDLEFBcUgvQixlQXJIOEMsV0FxSHhDLHdCQUF3QixLQUFBLE9BQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUM1RCxRQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7QUFDaEIsT0FBQyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7S0FDdEQ7QUFDRCxXQUFPLENBQUMsQ0FBQztHQUNWOztBQTFIa0IsZUFBYSxXQTRIaEMsbUJBQW1CLEdBQUEsVUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtBQUN0QyxXQTdIdUMsQUE2SGhDLGVBN0grQyxXQTZIekMsbUJBQW1CLEtBQUEsT0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0dBQ25GOztTQTlIa0IsYUFBYTtHQUFTLGVBQWU7O3FCQUFyQyxhQUFhIiwiZmlsZSI6InNyYy9zY29wZS1hbmFseXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTQgU2hhcGUgU2VjdXJpdHksIEluYy5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpXG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgcmVkdWNlLCB7TW9ub2lkYWxSZWR1Y2VyfSBmcm9tIFwic2hpZnQtcmVkdWNlclwiO1xuaW1wb3J0IFNjb3BlU3RhdGUgZnJvbSBcIi4vc2NvcGUtc3RhdGVcIjtcbmltcG9ydCB7UmVhZFJlZmVyZW5jZSwgV3JpdGVSZWZlcmVuY2UsIFJlYWRXcml0ZVJlZmVyZW5jZX0gZnJvbSBcIi4vcmVmZXJlbmNlXCI7XG5pbXBvcnQge0RlY2xhcmF0aW9uLCBWYXJEZWNsYXJhdGlvbiwgQ29uc3REZWNsYXJhdGlvbiwgTGV0RGVjbGFyYXRpb24sIENhdGNoRGVjbGFyYXRpb24sIFBhcmFtZXRlckRlY2xhcmF0aW9uLCBGdW5jdGlvbk5hbWVEZWNsYXJhdGlvbn0gZnJvbSBcIi4vZGVjbGFyYXRpb25cIjtcbmltcG9ydCB7U2NvcGVUeXBlfSBmcm9tIFwiLi9zY29wZVwiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY29wZUFuYWx5emVyIGV4dGVuZHMgTW9ub2lkYWxSZWR1Y2VyIHtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcihTY29wZVN0YXRlKTtcbiAgfVxuXG4gIHN0YXRpYyBhbmFseXplKHNjcmlwdCkge1xuICAgIHJldHVybiByZWR1Y2UobmV3IHRoaXMsIHNjcmlwdCkuY2hpbGRyZW5bMF07XG4gIH1cblxuICByZWR1Y2VBc3NpZ25tZW50RXhwcmVzc2lvbihub2RlLCBiaW5kaW5nLCBleHByZXNzaW9uKSB7XG4gICAgaWYgKG5vZGUuYmluZGluZy50eXBlID09PSBcIklkZW50aWZpZXJFeHByZXNzaW9uXCIpIHtcbiAgICAgIGxldCBSZWZlcmVuY2VDdG9yID0gbm9kZS5vcGVyYXRvciA9PT0gXCI9XCIgPyBXcml0ZVJlZmVyZW5jZSA6IFJlYWRXcml0ZVJlZmVyZW5jZTtcbiAgICAgIHJldHVybiBleHByZXNzaW9uLmFkZFJlZmVyZW5jZShuZXcgUmVmZXJlbmNlQ3Rvcihub2RlLmJpbmRpbmcuaWRlbnRpZmllcikpO1xuICAgIH1cbiAgICByZXR1cm4gc3VwZXIucmVkdWNlQXNzaWdubWVudEV4cHJlc3Npb24obm9kZSwgYmluZGluZywgZXhwcmVzc2lvbik7XG4gIH1cblxuICByZWR1Y2VCbG9jayhub2RlLCBzdGF0ZW1lbnRzKSB7XG4gICAgbGV0IHMgPSBzdXBlci5yZWR1Y2VCbG9jayhub2RlLCBzdGF0ZW1lbnRzKTtcbiAgICBpZiAocy5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucy5zaXplID4gMCkge1xuICAgICAgcyA9IHMuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5CTE9DSyk7XG4gICAgfVxuICAgIHJldHVybiBzO1xuICB9XG5cbiAgcmVkdWNlQ2FsbEV4cHJlc3Npb24obm9kZSwgY2FsbGVlLCBhcmdzKSB7XG4gICAgbGV0IHMgPSBzdXBlci5yZWR1Y2VDYWxsRXhwcmVzc2lvbihub2RlLCBjYWxsZWUsIGFyZ3MpO1xuICAgIGlmIChub2RlLmNhbGxlZS50eXBlID09PSBcIklkZW50aWZpZXJFeHByZXNzaW9uXCIgJiYgbm9kZS5jYWxsZWUuaWRlbnRpZmllci5uYW1lID09PSBcImV2YWxcIikge1xuICAgICAgcmV0dXJuIHMudGFpbnQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHM7XG4gIH1cblxuICByZWR1Y2VDYXRjaENsYXVzZShub2RlLCBiaW5kaW5nLCBib2R5KSB7XG4gICAgcmV0dXJuIHN1cGVyLnJlZHVjZUNhdGNoQ2xhdXNlKG5vZGUsIGJpbmRpbmcsIGJvZHkpXG4gICAgICAuYWRkRGVjbGFyYXRpb24obmV3IENhdGNoRGVjbGFyYXRpb24obm9kZS5iaW5kaW5nKSlcbiAgICAgIC5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkNBVENIKTtcbiAgfVxuXG4gIHJlZHVjZUZvckluU3RhdGVtZW50KG5vZGUsIGxlZnQsIHJpZ2h0LCBib2R5KSB7XG4gICAgaWYgKG5vZGUubGVmdC50eXBlID09PSBcIklkZW50aWZpZXJFeHByZXNzaW9uXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLmFwcGVuZChyaWdodCwgYm9keSkuYWRkUmVmZXJlbmNlKG5ldyBXcml0ZVJlZmVyZW5jZShub2RlLmxlZnQuaWRlbnRpZmllcikpO1xuICAgIH0gZWxzZSB7IC8vIG5vZGUubGVmdC50eXBlID09PSBcIlZhcmlhYmxlRGVjbGFyYXRpb25cIlxuICAgICAgbGV0IGRlY2xhcmF0b3IgPSBub2RlLmxlZnQuZGVjbGFyYXRvcnNbMF07XG4gICAgICBpZiAoZGVjbGFyYXRvci5pbml0ID09IG51bGwpIHtcbiAgICAgICAgbGVmdCA9IGxlZnQuYWRkUmVmZXJlbmNlKG5ldyBXcml0ZVJlZmVyZW5jZShkZWNsYXJhdG9yLmJpbmRpbmcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChsZWZ0LmJsb2NrU2NvcGVkRGVjbGFyYXRpb25zLnNpemUgPiAwKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwcGVuZCh0aGlzLmFwcGVuZChsZWZ0LCBib2R5KS5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkJMT0NLKSwgcmlnaHQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHN1cGVyLnJlZHVjZUZvckluU3RhdGVtZW50KG5vZGUsIGxlZnQsIHJpZ2h0LCBib2R5KTtcbiAgICB9XG4gIH1cblxuICByZWR1Y2VGb3JTdGF0ZW1lbnQobm9kZSwgaW5pdCwgdGVzdCwgdXBkYXRlLCBib2R5KSB7XG4gICAgaWYgKG5vZGUuaW5pdC50eXBlID09PSBcIlZhcmlhYmxlRGVjbGFyYXRpb25cIiAmJiBpbml0LmJsb2NrU2NvcGVkRGVjbGFyYXRpb25zLnNpemUgPiAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5hcHBlbmQzKHRoaXMuYXBwZW5kKGluaXQsIGJvZHkpLmZpbmlzaChub2RlLCBTY29wZVR5cGUuQkxPQ0spLCB0ZXN0LCB1cGRhdGUpO1xuICAgIH1cbiAgICByZXR1cm4gc3VwZXIucmVkdWNlRm9yU3RhdGVtZW50KG5vZGUsIGluaXQsIHRlc3QsIHVwZGF0ZSwgYm9keSk7XG4gIH1cblxuICByZWR1Y2VGdW5jdGlvbkRlY2xhcmF0aW9uKG5vZGUsIG5hbWUsIHBhcmFtZXRlcnMsIGZ1bmN0aW9uQm9keSkge1xuICAgIHJldHVybiBub2RlLnBhcmFtZXRlcnMucmVkdWNlKChzLCBwKSA9PiBzLmFkZERlY2xhcmF0aW9uKG5ldyBQYXJhbWV0ZXJEZWNsYXJhdGlvbihwKSksIGZ1bmN0aW9uQm9keSlcbiAgICAgIC5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkZVTkNUSU9OKVxuICAgICAgLmFkZERlY2xhcmF0aW9uKG5ldyBGdW5jdGlvbk5hbWVEZWNsYXJhdGlvbihub2RlLm5hbWUpKTtcbiAgfVxuXG4gIHJlZHVjZUZ1bmN0aW9uRXhwcmVzc2lvbihub2RlLCBuYW1lLCBwYXJhbWV0ZXJzLCBmdW5jdGlvbkJvZHkpIHtcbiAgICBsZXQgcyA9IG5vZGUucGFyYW1ldGVycy5yZWR1Y2UoKHMsIHApID0+IHMuYWRkRGVjbGFyYXRpb24obmV3IFBhcmFtZXRlckRlY2xhcmF0aW9uKHApKSwgZnVuY3Rpb25Cb2R5KVxuICAgICAgLmZpbmlzaChub2RlLCBTY29wZVR5cGUuRlVOQ1RJT04pO1xuICAgIGlmIChuYW1lICE9IG51bGwpIHtcbiAgICAgIHMgPSBzLmFkZERlY2xhcmF0aW9uKG5ldyBGdW5jdGlvbk5hbWVEZWNsYXJhdGlvbihub2RlLm5hbWUpKVxuICAgICAgICAuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5GVU5DVElPTl9OQU1FKTtcbiAgICB9XG4gICAgcmV0dXJuIHM7XG4gIH1cblxuICByZWR1Y2VHZXR0ZXIobm9kZSwgbmFtZSwgYm9keSkge1xuICAgIHJldHVybiBib2R5LmZpbmlzaChub2RlLCBTY29wZVR5cGUuRlVOQ1RJT04pO1xuICB9XG5cbiAgcmVkdWNlSWRlbnRpZmllckV4cHJlc3Npb24obm9kZSwgaWRlbnRpZmllcikge1xuICAgIHJldHVybiB0aGlzLmlkZW50aXR5LmFkZFJlZmVyZW5jZShuZXcgUmVhZFJlZmVyZW5jZShub2RlLmlkZW50aWZpZXIpKTtcbiAgfVxuXG4gIHJlZHVjZVBvc3RmaXhFeHByZXNzaW9uKG5vZGUsIG9wZXJhbmQpIHtcbiAgICBpZiAobm9kZS5vcGVyYW5kLnR5cGUgPT09IFwiSWRlbnRpZmllckV4cHJlc3Npb25cIikge1xuICAgICAgcmV0dXJuIHRoaXMuaWRlbnRpdHkuYWRkUmVmZXJlbmNlKG5ldyBSZWFkV3JpdGVSZWZlcmVuY2Uobm9kZS5vcGVyYW5kLmlkZW50aWZpZXIpKTtcbiAgICB9XG4gICAgcmV0dXJuIG9wZXJhbmQ7XG4gIH1cblxuICByZWR1Y2VQcmVmaXhFeHByZXNzaW9uKG5vZGUsIG9wZXJhbmQpIHtcbiAgICBpZiAoKG5vZGUub3BlcmF0b3IgPT09IFwiLS1cIiB8fCBub2RlLm9wZXJhdG9yID09PSBcIisrXCIpICYmIG5vZGUub3BlcmFuZC50eXBlID09PSBcIklkZW50aWZpZXJFeHByZXNzaW9uXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLmlkZW50aXR5LmFkZFJlZmVyZW5jZShuZXcgUmVhZFdyaXRlUmVmZXJlbmNlKG5vZGUub3BlcmFuZC5pZGVudGlmaWVyKSk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYW5kO1xuICB9XG5cbiAgcmVkdWNlU2NyaXB0KG5vZGUsIGJvZHkpIHtcbiAgICByZXR1cm4gYm9keS5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkdMT0JBTCk7XG4gIH1cblxuICByZWR1Y2VTZXR0ZXIobm9kZSwgbmFtZSwgcGFyYW1ldGVyLCBib2R5KSB7XG4gICAgcmV0dXJuIGJvZHkuYWRkRGVjbGFyYXRpb24obmV3IFBhcmFtZXRlckRlY2xhcmF0aW9uKG5vZGUucGFyYW1ldGVyKSlcbiAgICAgIC5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkZVTkNUSU9OKTtcbiAgfVxuXG4gIHJlZHVjZVZhcmlhYmxlRGVjbGFyYXRpb24obm9kZSwgZGVjbGFyYXRvcnMpIHtcbiAgICByZXR1cm4gbm9kZS5kZWNsYXJhdG9ycy5yZWR1Y2UoXG4gICAgICAocywgZCkgPT4gcy5hZGREZWNsYXJhdGlvbihEZWNsYXJhdGlvbi5mcm9tVmFyRGVjbEtpbmQoZC5iaW5kaW5nLCBub2RlLmtpbmQpKSxcbiAgICAgIHN1cGVyLnJlZHVjZVZhcmlhYmxlRGVjbGFyYXRpb24obm9kZSwgZGVjbGFyYXRvcnMpXG4gICAgKTtcbiAgfVxuXG4gIHJlZHVjZVZhcmlhYmxlRGVjbGFyYXRvcihub2RlLCBiaW5kaW5nLCBpbml0KSB7XG4gICAgbGV0IHMgPSBzdXBlci5yZWR1Y2VWYXJpYWJsZURlY2xhcmF0b3Iobm9kZSwgYmluZGluZywgaW5pdCk7XG4gICAgaWYgKGluaXQgIT0gbnVsbCkge1xuICAgICAgcyA9IHMuYWRkUmVmZXJlbmNlKG5ldyBXcml0ZVJlZmVyZW5jZShub2RlLmJpbmRpbmcpKTtcbiAgICB9XG4gICAgcmV0dXJuIHM7XG4gIH1cblxuICByZWR1Y2VXaXRoU3RhdGVtZW50KG5vZGUsIG9iamVjdCwgYm9keSkge1xuICAgIHJldHVybiBzdXBlci5yZWR1Y2VXaXRoU3RhdGVtZW50KG5vZGUsIG9iamVjdCwgYm9keS5maW5pc2gobm9kZSwgU2NvcGVUeXBlLldJVEgpKTtcbiAgfVxufVxuIl19