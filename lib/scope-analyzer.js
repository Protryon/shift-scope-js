"use strict";

var _extends = function (child, parent) {
  child.prototype = Object.create(parent.prototype, {
    constructor: {
      value: child,
      enumerable: false,
      writable: true,
      configurable: true
    }
  });
  child.__proto__ = parent;
};

var reduce = require("shift-reducer")["default"];
var MonoidalReducer = require("shift-reducer").MonoidalReducer;
var ScopeState = require("./scope-state")["default"];
var ReadReference = require("./reference").ReadReference;
var WriteReference = require("./reference").WriteReference;
var ReadWriteReference = require("./reference").ReadWriteReference;
var Declaration = require("./declaration").Declaration;
var VarDeclaration = require("./declaration").VarDeclaration;
var ConstDeclaration = require("./declaration").ConstDeclaration;
var LetDeclaration = require("./declaration").LetDeclaration;
var CatchDeclaration = require("./declaration").CatchDeclaration;
var ParameterDeclaration = require("./declaration").ParameterDeclaration;
var FunctionNameDeclaration = require("./declaration").FunctionNameDeclaration;
var ScopeType = require("./scope").ScopeType;
var ScopeAnalyzer = (function (MonoidalReducer) {
  var ScopeAnalyzer = function ScopeAnalyzer() {
    MonoidalReducer.call(this, ScopeState);
  };

  _extends(ScopeAnalyzer, MonoidalReducer);

  ScopeAnalyzer.analyze = function (script) {
    return reduce(new this(), script).children[0];
  };

  ScopeAnalyzer.prototype.reduceAssignmentExpression = function (node, binding, expression) {
    if (node.binding.type === "IdentifierExpression") {
      var ReferenceCtor = node.operator === "=" ? WriteReference : ReadWriteReference;
      return expression.addReference(new ReferenceCtor(node.binding.identifier));
    }
    return MonoidalReducer.prototype.reduceAssignmentExpression.call(this, node, binding, expression);
  };

  ScopeAnalyzer.prototype.reduceBlock = function (node, statements) {
    var s = MonoidalReducer.prototype.reduceBlock.call(this, node, statements);
    if (s.blockScopedDeclarations.size > 0) {
      s = s.finish(node, ScopeType.BLOCK);
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceCallExpression = function (node, callee, args) {
    var s = MonoidalReducer.prototype.reduceCallExpression.call(this, node, callee, args);
    if (node.callee.type === "IdentifierExpression" && node.callee.identifier.name === "eval") {
      return s.taint();
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceCatchClause = function (node, binding, body) {
    return MonoidalReducer.prototype.reduceCatchClause.call(this, node, binding, body).addDeclaration(new CatchDeclaration(node.binding)).finish(node, ScopeType.CATCH);
  };

  ScopeAnalyzer.prototype.reduceForInStatement = function (node, left, right, body) {
    if (node.left.type === "VariableDeclaration") {
      var declarator = node.left.declarators[0];
      if (declarator.init == null) {
        left = left.addReference(new WriteReference(declarator.binding));
      }
      if (left.blockScopedDeclarations.size > 0) {
        return this.append(this.append(left, body).finish(node, ScopeType.BLOCK), right);
      }
      return MonoidalReducer.prototype.reduceForInStatement.call(this, node, left, right, body);
    }
    return this.append(right, body).addReference(new WriteReference(node.left.identifier));
  };

  ScopeAnalyzer.prototype.reduceForStatement = function (node, init, test, update, body) {
    if (node.init.type === "VariableDeclaration" && init.blockScopedDeclarations.size > 0) {
      return this.append3(this.append(init, body).finish(node, ScopeType.BLOCK), test, update);
    }
    return MonoidalReducer.prototype.reduceForStatement.call(this, node, init, test, update, body);
  };

  ScopeAnalyzer.prototype.reduceFunctionDeclaration = function (node, name, parameters, functionBody) {
    return node.parameters.reduce(function (s, p) {
      return s.addDeclaration(new ParameterDeclaration(p));
    }, functionBody).finish(node, ScopeType.FUNCTION).addDeclaration(new FunctionNameDeclaration(node.name));
  };

  ScopeAnalyzer.prototype.reduceFunctionExpression = function (node, name, parameters, functionBody) {
    var s = node.parameters.reduce(function (s, p) {
      return s.addDeclaration(new ParameterDeclaration(p));
    }, functionBody).finish(node, ScopeType.FUNCTION);
    if (name != null) {
      s = s.addDeclaration(new FunctionNameDeclaration(node.name)).finish(node, ScopeType.FUNCTION_NAME);
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceGetter = function (node, name, body) {
    return body.finish(node, ScopeType.FUNCTION);
  };

  ScopeAnalyzer.prototype.reduceIdentifierExpression = function (node, identifier) {
    return this.identity.addReference(new ReadReference(node.identifier));
  };

  ScopeAnalyzer.prototype.reducePostfixExpression = function (node, operand) {
    if (node.operand.type === "IdentifierExpression") {
      return this.identity.addReference(new ReadWriteReference(node.operand.identifier));
    }
    return operand;
  };

  ScopeAnalyzer.prototype.reducePrefixExpression = function (node, operand) {
    if ((node.operator === "--" || node.operator === "++") && node.operand.type === "IdentifierExpression") {
      return this.identity.addReference(new ReadWriteReference(node.operand.identifier));
    }
    return operand;
  };

  ScopeAnalyzer.prototype.reduceScript = function (node, body) {
    return body.finish(node, ScopeType.GLOBAL);
  };

  ScopeAnalyzer.prototype.reduceSetter = function (node, name, parameter, body) {
    return body.addDeclaration(new ParameterDeclaration(node.parameter)).finish(node, ScopeType.FUNCTION);
  };

  ScopeAnalyzer.prototype.reduceVariableDeclaration = function (node, declarators) {
    return node.declarators.reduce(function (s, d) {
      return s.addDeclaration(Declaration.fromVarDeclKind(d.binding, node.kind));
    }, MonoidalReducer.prototype.reduceVariableDeclaration.call(this, node, declarators));
  };

  ScopeAnalyzer.prototype.reduceVariableDeclarator = function (node, binding, init) {
    var s = MonoidalReducer.prototype.reduceVariableDeclarator.call(this, node, binding, init);
    if (init != null) {
      s = s.addReference(new WriteReference(node.binding));
    }
    return s;
  };

  ScopeAnalyzer.prototype.reduceWithStatement = function (node, object, body) {
    return MonoidalReducer.prototype.reduceWithStatement.call(this, node, object, body.finish(node, ScopeType.WITH));
  };

  return ScopeAnalyzer;
})(MonoidalReducer);

exports["default"] = ScopeAnalyzer;
//# sourceMappingURL=data:application/json;base64,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RUFBRSxJQUFJLEVBQUU7QUFDNUMsUUFBSSxDQUFDLEdBcEhrQyxBQW9IL0IsZUFwSDhDLFdBb0h4Qyx3QkFBd0IsS0FBQSxPQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDNUQsUUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO0FBQ2hCLE9BQUMsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ3REO0FBQ0QsV0FBTyxDQUFDLENBQUM7R0FDVjs7QUF6SGtCLGVBQWEsV0EySGhDLG1CQUFtQixHQUFBLFVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7QUFDdEMsV0E1SHVDLEFBNEhoQyxlQTVIK0MsV0E0SHpDLG1CQUFtQixLQUFBLE9BQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztHQUNuRjs7U0E3SGtCLGFBQWE7R0FBUyxlQUFlOztxQkFBckMsYUFBYSIsImZpbGUiOiJzcmMvc2NvcGUtYW5hbHl6ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDE0IFNoYXBlIFNlY3VyaXR5LCBJbmMuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKVxuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHJlZHVjZSwge01vbm9pZGFsUmVkdWNlcn0gZnJvbSBcInNoaWZ0LXJlZHVjZXJcIjtcbmltcG9ydCBTY29wZVN0YXRlIGZyb20gXCIuL3Njb3BlLXN0YXRlXCI7XG5pbXBvcnQge1JlYWRSZWZlcmVuY2UsIFdyaXRlUmVmZXJlbmNlLCBSZWFkV3JpdGVSZWZlcmVuY2V9IGZyb20gXCIuL3JlZmVyZW5jZVwiO1xuaW1wb3J0IHtEZWNsYXJhdGlvbiwgVmFyRGVjbGFyYXRpb24sIENvbnN0RGVjbGFyYXRpb24sIExldERlY2xhcmF0aW9uLCBDYXRjaERlY2xhcmF0aW9uLCBQYXJhbWV0ZXJEZWNsYXJhdGlvbiwgRnVuY3Rpb25OYW1lRGVjbGFyYXRpb259IGZyb20gXCIuL2RlY2xhcmF0aW9uXCI7XG5pbXBvcnQge1Njb3BlVHlwZX0gZnJvbSBcIi4vc2NvcGVcIjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2NvcGVBbmFseXplciBleHRlbmRzIE1vbm9pZGFsUmVkdWNlciB7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoU2NvcGVTdGF0ZSk7XG4gIH1cblxuICBzdGF0aWMgYW5hbHl6ZShzY3JpcHQpIHtcbiAgICByZXR1cm4gcmVkdWNlKG5ldyB0aGlzLCBzY3JpcHQpLmNoaWxkcmVuWzBdO1xuICB9XG5cbiAgcmVkdWNlQXNzaWdubWVudEV4cHJlc3Npb24obm9kZSwgYmluZGluZywgZXhwcmVzc2lvbikge1xuICAgIGlmIChub2RlLmJpbmRpbmcudHlwZSA9PT0gXCJJZGVudGlmaWVyRXhwcmVzc2lvblwiKSB7XG4gICAgICBsZXQgUmVmZXJlbmNlQ3RvciA9IG5vZGUub3BlcmF0b3IgPT09IFwiPVwiID8gV3JpdGVSZWZlcmVuY2UgOiBSZWFkV3JpdGVSZWZlcmVuY2U7XG4gICAgICByZXR1cm4gZXhwcmVzc2lvbi5hZGRSZWZlcmVuY2UobmV3IFJlZmVyZW5jZUN0b3Iobm9kZS5iaW5kaW5nLmlkZW50aWZpZXIpKTtcbiAgICB9XG4gICAgcmV0dXJuIHN1cGVyLnJlZHVjZUFzc2lnbm1lbnRFeHByZXNzaW9uKG5vZGUsIGJpbmRpbmcsIGV4cHJlc3Npb24pO1xuICB9XG5cbiAgcmVkdWNlQmxvY2sobm9kZSwgc3RhdGVtZW50cykge1xuICAgIGxldCBzID0gc3VwZXIucmVkdWNlQmxvY2sobm9kZSwgc3RhdGVtZW50cyk7XG4gICAgaWYgKHMuYmxvY2tTY29wZWREZWNsYXJhdGlvbnMuc2l6ZSA+IDApIHtcbiAgICAgIHMgPSBzLmZpbmlzaChub2RlLCBTY29wZVR5cGUuQkxPQ0spO1xuICAgIH1cbiAgICByZXR1cm4gcztcbiAgfVxuXG4gIHJlZHVjZUNhbGxFeHByZXNzaW9uKG5vZGUsIGNhbGxlZSwgYXJncykge1xuICAgIGxldCBzID0gc3VwZXIucmVkdWNlQ2FsbEV4cHJlc3Npb24obm9kZSwgY2FsbGVlLCBhcmdzKTtcbiAgICBpZiAobm9kZS5jYWxsZWUudHlwZSA9PT0gXCJJZGVudGlmaWVyRXhwcmVzc2lvblwiICYmIG5vZGUuY2FsbGVlLmlkZW50aWZpZXIubmFtZSA9PT0gXCJldmFsXCIpIHtcbiAgICAgIHJldHVybiBzLnRhaW50KCk7XG4gICAgfVxuICAgIHJldHVybiBzO1xuICB9XG5cbiAgcmVkdWNlQ2F0Y2hDbGF1c2Uobm9kZSwgYmluZGluZywgYm9keSkge1xuICAgIHJldHVybiBzdXBlci5yZWR1Y2VDYXRjaENsYXVzZShub2RlLCBiaW5kaW5nLCBib2R5KVxuICAgICAgLmFkZERlY2xhcmF0aW9uKG5ldyBDYXRjaERlY2xhcmF0aW9uKG5vZGUuYmluZGluZykpXG4gICAgICAuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5DQVRDSCk7XG4gIH1cblxuICByZWR1Y2VGb3JJblN0YXRlbWVudChub2RlLCBsZWZ0LCByaWdodCwgYm9keSkge1xuICAgIGlmIChub2RlLmxlZnQudHlwZSA9PT0gXCJWYXJpYWJsZURlY2xhcmF0aW9uXCIpIHtcbiAgICAgIGxldCBkZWNsYXJhdG9yID0gbm9kZS5sZWZ0LmRlY2xhcmF0b3JzWzBdO1xuICAgICAgaWYgKGRlY2xhcmF0b3IuaW5pdCA9PSBudWxsKSB7XG4gICAgICAgIGxlZnQgPSBsZWZ0LmFkZFJlZmVyZW5jZShuZXcgV3JpdGVSZWZlcmVuY2UoZGVjbGFyYXRvci5iaW5kaW5nKSk7XG4gICAgICB9XG4gICAgICBpZiAobGVmdC5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucy5zaXplID4gMCkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBlbmQodGhpcy5hcHBlbmQobGVmdCwgYm9keSkuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5CTE9DSyksIHJpZ2h0KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdXBlci5yZWR1Y2VGb3JJblN0YXRlbWVudChub2RlLCBsZWZ0LCByaWdodCwgYm9keSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmFwcGVuZChyaWdodCwgYm9keSkuYWRkUmVmZXJlbmNlKG5ldyBXcml0ZVJlZmVyZW5jZShub2RlLmxlZnQuaWRlbnRpZmllcikpO1xuICB9XG5cbiAgcmVkdWNlRm9yU3RhdGVtZW50KG5vZGUsIGluaXQsIHRlc3QsIHVwZGF0ZSwgYm9keSkge1xuICAgIGlmIChub2RlLmluaXQudHlwZSA9PT0gXCJWYXJpYWJsZURlY2xhcmF0aW9uXCIgJiYgaW5pdC5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucy5zaXplID4gMCkge1xuICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kMyh0aGlzLmFwcGVuZChpbml0LCBib2R5KS5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkJMT0NLKSwgdGVzdCwgdXBkYXRlKTtcbiAgICB9XG4gICAgcmV0dXJuIHN1cGVyLnJlZHVjZUZvclN0YXRlbWVudChub2RlLCBpbml0LCB0ZXN0LCB1cGRhdGUsIGJvZHkpO1xuICB9XG5cbiAgcmVkdWNlRnVuY3Rpb25EZWNsYXJhdGlvbihub2RlLCBuYW1lLCBwYXJhbWV0ZXJzLCBmdW5jdGlvbkJvZHkpIHtcbiAgICByZXR1cm4gbm9kZS5wYXJhbWV0ZXJzLnJlZHVjZSgocywgcCkgPT4gcy5hZGREZWNsYXJhdGlvbihuZXcgUGFyYW1ldGVyRGVjbGFyYXRpb24ocCkpLCBmdW5jdGlvbkJvZHkpXG4gICAgICAuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5GVU5DVElPTilcbiAgICAgIC5hZGREZWNsYXJhdGlvbihuZXcgRnVuY3Rpb25OYW1lRGVjbGFyYXRpb24obm9kZS5uYW1lKSk7XG4gIH1cblxuICByZWR1Y2VGdW5jdGlvbkV4cHJlc3Npb24obm9kZSwgbmFtZSwgcGFyYW1ldGVycywgZnVuY3Rpb25Cb2R5KSB7XG4gICAgbGV0IHMgPSBub2RlLnBhcmFtZXRlcnMucmVkdWNlKChzLCBwKSA9PiBzLmFkZERlY2xhcmF0aW9uKG5ldyBQYXJhbWV0ZXJEZWNsYXJhdGlvbihwKSksIGZ1bmN0aW9uQm9keSlcbiAgICAgIC5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkZVTkNUSU9OKTtcbiAgICBpZiAobmFtZSAhPSBudWxsKSB7XG4gICAgICBzID0gcy5hZGREZWNsYXJhdGlvbihuZXcgRnVuY3Rpb25OYW1lRGVjbGFyYXRpb24obm9kZS5uYW1lKSlcbiAgICAgICAgLmZpbmlzaChub2RlLCBTY29wZVR5cGUuRlVOQ1RJT05fTkFNRSk7XG4gICAgfVxuICAgIHJldHVybiBzO1xuICB9XG5cbiAgcmVkdWNlR2V0dGVyKG5vZGUsIG5hbWUsIGJvZHkpIHtcbiAgICByZXR1cm4gYm9keS5maW5pc2gobm9kZSwgU2NvcGVUeXBlLkZVTkNUSU9OKTtcbiAgfVxuXG4gIHJlZHVjZUlkZW50aWZpZXJFeHByZXNzaW9uKG5vZGUsIGlkZW50aWZpZXIpIHtcbiAgICByZXR1cm4gdGhpcy5pZGVudGl0eS5hZGRSZWZlcmVuY2UobmV3IFJlYWRSZWZlcmVuY2Uobm9kZS5pZGVudGlmaWVyKSk7XG4gIH1cblxuICByZWR1Y2VQb3N0Zml4RXhwcmVzc2lvbihub2RlLCBvcGVyYW5kKSB7XG4gICAgaWYgKG5vZGUub3BlcmFuZC50eXBlID09PSBcIklkZW50aWZpZXJFeHByZXNzaW9uXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLmlkZW50aXR5LmFkZFJlZmVyZW5jZShuZXcgUmVhZFdyaXRlUmVmZXJlbmNlKG5vZGUub3BlcmFuZC5pZGVudGlmaWVyKSk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYW5kO1xuICB9XG5cbiAgcmVkdWNlUHJlZml4RXhwcmVzc2lvbihub2RlLCBvcGVyYW5kKSB7XG4gICAgaWYgKChub2RlLm9wZXJhdG9yID09PSBcIi0tXCIgfHwgbm9kZS5vcGVyYXRvciA9PT0gXCIrK1wiKSAmJiBub2RlLm9wZXJhbmQudHlwZSA9PT0gXCJJZGVudGlmaWVyRXhwcmVzc2lvblwiKSB7XG4gICAgICByZXR1cm4gdGhpcy5pZGVudGl0eS5hZGRSZWZlcmVuY2UobmV3IFJlYWRXcml0ZVJlZmVyZW5jZShub2RlLm9wZXJhbmQuaWRlbnRpZmllcikpO1xuICAgIH1cbiAgICByZXR1cm4gb3BlcmFuZDtcbiAgfVxuXG4gIHJlZHVjZVNjcmlwdChub2RlLCBib2R5KSB7XG4gICAgcmV0dXJuIGJvZHkuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5HTE9CQUwpO1xuICB9XG5cbiAgcmVkdWNlU2V0dGVyKG5vZGUsIG5hbWUsIHBhcmFtZXRlciwgYm9keSkge1xuICAgIHJldHVybiBib2R5LmFkZERlY2xhcmF0aW9uKG5ldyBQYXJhbWV0ZXJEZWNsYXJhdGlvbihub2RlLnBhcmFtZXRlcikpXG4gICAgICAuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5GVU5DVElPTik7XG4gIH1cblxuICByZWR1Y2VWYXJpYWJsZURlY2xhcmF0aW9uKG5vZGUsIGRlY2xhcmF0b3JzKSB7XG4gICAgcmV0dXJuIG5vZGUuZGVjbGFyYXRvcnMucmVkdWNlKFxuICAgICAgKHMsIGQpID0+IHMuYWRkRGVjbGFyYXRpb24oRGVjbGFyYXRpb24uZnJvbVZhckRlY2xLaW5kKGQuYmluZGluZywgbm9kZS5raW5kKSksXG4gICAgICBzdXBlci5yZWR1Y2VWYXJpYWJsZURlY2xhcmF0aW9uKG5vZGUsIGRlY2xhcmF0b3JzKVxuICAgICk7XG4gIH1cblxuICByZWR1Y2VWYXJpYWJsZURlY2xhcmF0b3Iobm9kZSwgYmluZGluZywgaW5pdCkge1xuICAgIGxldCBzID0gc3VwZXIucmVkdWNlVmFyaWFibGVEZWNsYXJhdG9yKG5vZGUsIGJpbmRpbmcsIGluaXQpO1xuICAgIGlmIChpbml0ICE9IG51bGwpIHtcbiAgICAgIHMgPSBzLmFkZFJlZmVyZW5jZShuZXcgV3JpdGVSZWZlcmVuY2Uobm9kZS5iaW5kaW5nKSk7XG4gICAgfVxuICAgIHJldHVybiBzO1xuICB9XG5cbiAgcmVkdWNlV2l0aFN0YXRlbWVudChub2RlLCBvYmplY3QsIGJvZHkpIHtcbiAgICByZXR1cm4gc3VwZXIucmVkdWNlV2l0aFN0YXRlbWVudChub2RlLCBvYmplY3QsIGJvZHkuZmluaXNoKG5vZGUsIFNjb3BlVHlwZS5XSVRIKSk7XG4gIH1cbn1cbiJdfQ==