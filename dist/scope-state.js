"use strict";

var MultiMap = require("multimap");

function merge(multiMap, otherMultiMap) {
  otherMultiMap.forEachEntry(function (v, k) {
    multiMap.set.apply(multiMap, [k].concat(v));
  });
  return multiMap;
}

var Scope = require("./scope").Scope;
var GlobalScope = require("./scope").GlobalScope;
var ScopeType = require("./scope").ScopeType;
var Variable = require("./variable")["default"];


function resolveArguments(freeIdentifiers, variables) {
  var args = freeIdentifiers.get("arguments") || [];
  freeIdentifiers["delete"]("arguments");
  return variables.concat(new Variable("arguments", args, []));
}

function resolveDeclarations(freeIdentifiers, decls, variables) {
  decls.forEachEntry(function (declarations, name) {
    var references = freeIdentifiers.get(name) || [];
    variables = variables.concat(new Variable(name, references, declarations));
    freeIdentifiers["delete"](name);
  });
  return variables;
}

var ScopeState = (function () {
  var ScopeState = function ScopeState(freeIdentifiers, functionScopedDeclarations, blockScopedDeclarations, children, dynamic) {
    this.freeIdentifiers = freeIdentifiers;
    this.functionScopedDeclarations = functionScopedDeclarations;
    this.blockScopedDeclarations = blockScopedDeclarations;
    this.children = children;
    this.dynamic = dynamic;
  };

  ScopeState.empty = function () {
    return new ScopeState(new MultiMap(), new MultiMap(), new MultiMap(), [], false);
  };

  ScopeState.prototype.concat = function (b) {
    if (this === b) {
      return this;
    }
    return new ScopeState(merge(merge(new MultiMap(), this.freeIdentifiers), b.freeIdentifiers), merge(merge(new MultiMap(), this.functionScopedDeclarations), b.functionScopedDeclarations), merge(merge(new MultiMap(), this.blockScopedDeclarations), b.blockScopedDeclarations), this.children.concat(b.children), this.dynamic || b.dynamic);
  };

  ScopeState.prototype.addDeclaration = function (decl) {
    var declMap = new MultiMap();
    merge(declMap, decl.type.isBlockScoped ? this.blockScopedDeclarations : this.functionScopedDeclarations);
    declMap.set(decl.node.name, decl);
    return new ScopeState(this.freeIdentifiers, decl.type.isBlockScoped ? this.functionScopedDeclarations : declMap, decl.type.isBlockScoped ? declMap : this.blockScopedDeclarations, this.children, this.dynamic);
  };

  ScopeState.prototype.addReference = function (ref) {
    var freeMap = new MultiMap();
    merge(freeMap, this.freeIdentifiers);
    freeMap.set(ref.node.name, ref);
    return new ScopeState(freeMap, this.functionScopedDeclarations, this.blockScopedDeclarations, this.children, this.dynamic);
  };

  ScopeState.prototype.taint = function () {
    return new ScopeState(this.freeIdentifiers, this.functionScopedDeclarations, this.blockScopedDeclarations, this.children, true);
  };

  ScopeState.prototype.finish = function (astNode, scopeType) {
    var variables = [];
    var functionScope = new MultiMap();
    var freeIdentifiers = new MultiMap();

    merge(freeIdentifiers, this.freeIdentifiers);

    switch (scopeType) {
      case ScopeType.BLOCK:
      case ScopeType.CATCH:
      case ScopeType.WITH:
        // resolve references to only block-scoped free declarations
        variables = resolveDeclarations(freeIdentifiers, this.blockScopedDeclarations, variables);
        merge(functionScope, this.functionScopedDeclarations);
        break;
      default:
        // resolve references to both block-scoped and function-scoped free declarations
        if (scopeType === ScopeType.FUNCTION) {
          variables = resolveArguments(freeIdentifiers, variables);
        }
        variables = resolveDeclarations(freeIdentifiers, this.blockScopedDeclarations, variables);
        variables = resolveDeclarations(freeIdentifiers, this.functionScopedDeclarations, variables);
        break;
    }

    var scope = scopeType === ScopeType.GLOBAL ? new GlobalScope(this.children, variables, freeIdentifiers, astNode) : new Scope(this.children, variables, freeIdentifiers, scopeType, this.dynamic, astNode);

    return new ScopeState(freeIdentifiers, functionScope, new MultiMap(), [scope], false);
  };

  return ScopeState;
})();

exports["default"] = ScopeState;
//# sourceMappingURL=data:application/json;base64,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QWUsRUFBRSxJQUFJLENBQUMsMEJBQTBCLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDN0YsY0FBTTtBQUFBLEtBQ1A7O0FBRUQsUUFBSSxLQUFLLEdBQUcsU0FBUyxLQUFLLFNBQVMsQ0FBQyxNQUFNLEdBQ3RDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxPQUFPLENBQUMsR0FDbkUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDOztBQUUzRixXQUFPLElBQUksVUFBVSxDQUNuQixlQUFlLEVBQ2YsYUFBYSxFQUNiLElBQUksUUFBUSxFQUFBLEVBQ1osQ0FBQyxLQUFLLENBQUMsRUFDUCxLQUFLLENBQ04sQ0FBQztHQUNIOztTQXRIa0IsVUFBVTs7O3FCQUFWLFVBQVUiLCJmaWxlIjoic3JjL3Njb3BlLXN0YXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgMjAxNCBTaGFwZSBTZWN1cml0eSwgSW5jLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIilcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIE11bHRpTWFwIGZyb20gXCJtdWx0aW1hcFwiO1xuXG5mdW5jdGlvbiBtZXJnZShtdWx0aU1hcCwgb3RoZXJNdWx0aU1hcCkge1xuICBvdGhlck11bHRpTWFwLmZvckVhY2hFbnRyeSgodiwgaykgPT4ge1xuICAgIG11bHRpTWFwLnNldC5hcHBseShtdWx0aU1hcCwgW2tdLmNvbmNhdCh2KSk7XG4gIH0pO1xuICByZXR1cm4gbXVsdGlNYXA7XG59XG5cbmltcG9ydCB7U2NvcGUsIEdsb2JhbFNjb3BlLCBTY29wZVR5cGV9IGZyb20gXCIuL3Njb3BlXCI7XG5pbXBvcnQgVmFyaWFibGUgZnJvbSBcIi4vdmFyaWFibGVcIjtcblxuZnVuY3Rpb24gcmVzb2x2ZUFyZ3VtZW50cyhmcmVlSWRlbnRpZmllcnMsIHZhcmlhYmxlcykge1xuICBsZXQgYXJncyA9IGZyZWVJZGVudGlmaWVycy5nZXQoXCJhcmd1bWVudHNcIikgfHwgW107XG4gIGZyZWVJZGVudGlmaWVycy5kZWxldGUoXCJhcmd1bWVudHNcIik7XG4gIHJldHVybiB2YXJpYWJsZXMuY29uY2F0KG5ldyBWYXJpYWJsZShcImFyZ3VtZW50c1wiLCBhcmdzLCBbXSkpO1xufVxuXG5mdW5jdGlvbiByZXNvbHZlRGVjbGFyYXRpb25zKGZyZWVJZGVudGlmaWVycywgZGVjbHMsIHZhcmlhYmxlcykge1xuICBkZWNscy5mb3JFYWNoRW50cnkoKGRlY2xhcmF0aW9ucywgbmFtZSkgPT4ge1xuICAgIGxldCByZWZlcmVuY2VzID0gZnJlZUlkZW50aWZpZXJzLmdldChuYW1lKSB8fCBbXTtcbiAgICB2YXJpYWJsZXMgPSB2YXJpYWJsZXMuY29uY2F0KG5ldyBWYXJpYWJsZShuYW1lLCByZWZlcmVuY2VzLCBkZWNsYXJhdGlvbnMpKTtcbiAgICBmcmVlSWRlbnRpZmllcnMuZGVsZXRlKG5hbWUpO1xuICB9KTtcbiAgcmV0dXJuIHZhcmlhYmxlcztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2NvcGVTdGF0ZSB7XG4gIGNvbnN0cnVjdG9yKGZyZWVJZGVudGlmaWVycywgZnVuY3Rpb25TY29wZWREZWNsYXJhdGlvbnMsIGJsb2NrU2NvcGVkRGVjbGFyYXRpb25zLCBjaGlsZHJlbiwgZHluYW1pYykge1xuICAgIHRoaXMuZnJlZUlkZW50aWZpZXJzID0gZnJlZUlkZW50aWZpZXJzO1xuICAgIHRoaXMuZnVuY3Rpb25TY29wZWREZWNsYXJhdGlvbnMgPSBmdW5jdGlvblNjb3BlZERlY2xhcmF0aW9ucztcbiAgICB0aGlzLmJsb2NrU2NvcGVkRGVjbGFyYXRpb25zID0gYmxvY2tTY29wZWREZWNsYXJhdGlvbnM7XG4gICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuO1xuICAgIHRoaXMuZHluYW1pYyA9IGR5bmFtaWM7XG4gIH1cblxuICBzdGF0aWMgZW1wdHkoKSB7XG4gICAgcmV0dXJuIG5ldyBTY29wZVN0YXRlKFxuICAgICAgbmV3IE11bHRpTWFwLFxuICAgICAgbmV3IE11bHRpTWFwLFxuICAgICAgbmV3IE11bHRpTWFwLFxuICAgICAgW10sXG4gICAgICBmYWxzZVxuICAgICk7XG4gIH1cblxuICAvKlxuICAgKiBNb25vaWRhbCBhcHBlbmQ6IG1lcmdlcyB0aGUgdHdvIHN0YXRlcyB0b2dldGhlclxuICAgKi9cbiAgY29uY2F0KGIpIHtcbiAgICBpZiAodGhpcyA9PT0gYikge1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIHJldHVybiBuZXcgU2NvcGVTdGF0ZShcbiAgICAgIG1lcmdlKG1lcmdlKG5ldyBNdWx0aU1hcCwgdGhpcy5mcmVlSWRlbnRpZmllcnMpLCBiLmZyZWVJZGVudGlmaWVycyksXG4gICAgICBtZXJnZShtZXJnZShuZXcgTXVsdGlNYXAsIHRoaXMuZnVuY3Rpb25TY29wZWREZWNsYXJhdGlvbnMpLCBiLmZ1bmN0aW9uU2NvcGVkRGVjbGFyYXRpb25zKSxcbiAgICAgIG1lcmdlKG1lcmdlKG5ldyBNdWx0aU1hcCwgdGhpcy5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucyksIGIuYmxvY2tTY29wZWREZWNsYXJhdGlvbnMpLFxuICAgICAgdGhpcy5jaGlsZHJlbi5jb25jYXQoYi5jaGlsZHJlbiksXG4gICAgICB0aGlzLmR5bmFtaWMgfHwgYi5keW5hbWljXG4gICAgKTtcbiAgfVxuXG4gIC8qXG4gICAqIE9ic2VydmUgYSB2YXJpYWJsZSBlbnRlcmluZyBzY29wZVxuICAgKi9cbiAgYWRkRGVjbGFyYXRpb24oZGVjbCkge1xuICAgIGxldCBkZWNsTWFwID0gbmV3IE11bHRpTWFwO1xuICAgIG1lcmdlKGRlY2xNYXAsIGRlY2wudHlwZS5pc0Jsb2NrU2NvcGVkID8gdGhpcy5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucyA6IHRoaXMuZnVuY3Rpb25TY29wZWREZWNsYXJhdGlvbnMpO1xuICAgIGRlY2xNYXAuc2V0KGRlY2wubm9kZS5uYW1lLCBkZWNsKTtcbiAgICByZXR1cm4gbmV3IFNjb3BlU3RhdGUoXG4gICAgICB0aGlzLmZyZWVJZGVudGlmaWVycyxcbiAgICAgIGRlY2wudHlwZS5pc0Jsb2NrU2NvcGVkID8gdGhpcy5mdW5jdGlvblNjb3BlZERlY2xhcmF0aW9ucyA6IGRlY2xNYXAsXG4gICAgICBkZWNsLnR5cGUuaXNCbG9ja1Njb3BlZCA/IGRlY2xNYXAgOiB0aGlzLmJsb2NrU2NvcGVkRGVjbGFyYXRpb25zLFxuICAgICAgdGhpcy5jaGlsZHJlbixcbiAgICAgIHRoaXMuZHluYW1pY1xuICAgICk7XG4gIH1cblxuICAvKlxuICAgKiBPYnNlcnZlIGEgcmVmZXJlbmNlIHRvIGEgdmFyaWFibGVcbiAgICovXG4gIGFkZFJlZmVyZW5jZShyZWYpIHtcbiAgICBsZXQgZnJlZU1hcCA9IG5ldyBNdWx0aU1hcDtcbiAgICBtZXJnZShmcmVlTWFwLCB0aGlzLmZyZWVJZGVudGlmaWVycyk7XG4gICAgZnJlZU1hcC5zZXQocmVmLm5vZGUubmFtZSwgcmVmKTtcbiAgICByZXR1cm4gbmV3IFNjb3BlU3RhdGUoXG4gICAgICBmcmVlTWFwLFxuICAgICAgdGhpcy5mdW5jdGlvblNjb3BlZERlY2xhcmF0aW9ucyxcbiAgICAgIHRoaXMuYmxvY2tTY29wZWREZWNsYXJhdGlvbnMsXG4gICAgICB0aGlzLmNoaWxkcmVuLFxuICAgICAgdGhpcy5keW5hbWljXG4gICAgKTtcbiAgfVxuXG4gIHRhaW50KCkge1xuICAgIHJldHVybiBuZXcgU2NvcGVTdGF0ZShcbiAgICAgIHRoaXMuZnJlZUlkZW50aWZpZXJzLFxuICAgICAgdGhpcy5mdW5jdGlvblNjb3BlZERlY2xhcmF0aW9ucyxcbiAgICAgIHRoaXMuYmxvY2tTY29wZWREZWNsYXJhdGlvbnMsXG4gICAgICB0aGlzLmNoaWxkcmVuLFxuICAgICAgdHJ1ZVxuICAgICk7XG4gIH1cblxuICAvKlxuICAgKiBVc2VkIHdoZW4gYSBzY29wZSBib3VuZGFyeSBpcyBlbmNvdW50ZXJlZC4gUmVzb2x2ZXMgZm91bmQgZnJlZSBpZGVudGlmaWVyc1xuICAgKiBhbmQgZGVjbGFyYXRpb25zIGludG8gdmFyaWFibGUgb2JqZWN0cy4gQW55IGZyZWUgaWRlbnRpZmllcnMgcmVtYWluaW5nIGFyZVxuICAgKiBjYXJyaWVkIGZvcndhcmQgaW50byB0aGUgbmV3IHN0YXRlIG9iamVjdC5cbiAgICovXG4gIGZpbmlzaChhc3ROb2RlLCBzY29wZVR5cGUpIHtcbiAgICBsZXQgdmFyaWFibGVzID0gW107XG4gICAgbGV0IGZ1bmN0aW9uU2NvcGUgPSBuZXcgTXVsdGlNYXA7XG4gICAgbGV0IGZyZWVJZGVudGlmaWVycyA9IG5ldyBNdWx0aU1hcDtcblxuICAgIG1lcmdlKGZyZWVJZGVudGlmaWVycywgdGhpcy5mcmVlSWRlbnRpZmllcnMpO1xuXG4gICAgc3dpdGNoIChzY29wZVR5cGUpIHtcbiAgICBjYXNlIFNjb3BlVHlwZS5CTE9DSzpcbiAgICBjYXNlIFNjb3BlVHlwZS5DQVRDSDpcbiAgICBjYXNlIFNjb3BlVHlwZS5XSVRIOlxuICAgICAgLy8gcmVzb2x2ZSByZWZlcmVuY2VzIHRvIG9ubHkgYmxvY2stc2NvcGVkIGZyZWUgZGVjbGFyYXRpb25zXG4gICAgICB2YXJpYWJsZXMgPSByZXNvbHZlRGVjbGFyYXRpb25zKGZyZWVJZGVudGlmaWVycywgdGhpcy5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucywgdmFyaWFibGVzKTtcbiAgICAgIG1lcmdlKGZ1bmN0aW9uU2NvcGUsIHRoaXMuZnVuY3Rpb25TY29wZWREZWNsYXJhdGlvbnMpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIHJlc29sdmUgcmVmZXJlbmNlcyB0byBib3RoIGJsb2NrLXNjb3BlZCBhbmQgZnVuY3Rpb24tc2NvcGVkIGZyZWUgZGVjbGFyYXRpb25zXG4gICAgICBpZiAoc2NvcGVUeXBlID09PSBTY29wZVR5cGUuRlVOQ1RJT04pIHtcbiAgICAgICAgdmFyaWFibGVzID0gcmVzb2x2ZUFyZ3VtZW50cyhmcmVlSWRlbnRpZmllcnMsIHZhcmlhYmxlcyk7XG4gICAgICB9XG4gICAgICB2YXJpYWJsZXMgPSByZXNvbHZlRGVjbGFyYXRpb25zKGZyZWVJZGVudGlmaWVycywgdGhpcy5ibG9ja1Njb3BlZERlY2xhcmF0aW9ucywgdmFyaWFibGVzKTtcbiAgICAgIHZhcmlhYmxlcyA9IHJlc29sdmVEZWNsYXJhdGlvbnMoZnJlZUlkZW50aWZpZXJzLCB0aGlzLmZ1bmN0aW9uU2NvcGVkRGVjbGFyYXRpb25zLCB2YXJpYWJsZXMpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgbGV0IHNjb3BlID0gc2NvcGVUeXBlID09PSBTY29wZVR5cGUuR0xPQkFMXG4gICAgICA/IG5ldyBHbG9iYWxTY29wZSh0aGlzLmNoaWxkcmVuLCB2YXJpYWJsZXMsIGZyZWVJZGVudGlmaWVycywgYXN0Tm9kZSlcbiAgICAgIDogbmV3IFNjb3BlKHRoaXMuY2hpbGRyZW4sIHZhcmlhYmxlcywgZnJlZUlkZW50aWZpZXJzLCBzY29wZVR5cGUsIHRoaXMuZHluYW1pYywgYXN0Tm9kZSk7XG5cbiAgICByZXR1cm4gbmV3IFNjb3BlU3RhdGUoXG4gICAgICBmcmVlSWRlbnRpZmllcnMsXG4gICAgICBmdW5jdGlvblNjb3BlLFxuICAgICAgbmV3IE11bHRpTWFwLFxuICAgICAgW3Njb3BlXSxcbiAgICAgIGZhbHNlXG4gICAgKTtcbiAgfVxufVxuIl19